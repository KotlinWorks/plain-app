import{d as X,a as ee,u as te,p as ae,r as d,s as se,c as ne,i as oe,a1 as N,aP as ie,N as B,H as le,I as ce,J as re,e as u,f as n,x as h,y as f,h as l,k as de,aZ as ue,a_ as pe,a$ as _e,o as c,F as ve,A as me,t as v,b0 as M,j as K,L as he,K as $,S as Q,g as R,b1 as z,Q as fe,al as y,w as m,Y as F,b2 as ye,ap as ge,b3 as Ce,au as ke,av as Ae,_ as be}from"./index-5dfa21ef.js";import{g as G,M as we}from"./splitpanes.es-1537f4f0.js";import{u as Ie}from"./markdown-fe32200a.js";const Me=g=>(ke("data-v-efe3c819"),g=g(),Ae(),g),$e={class:"page-container"},xe={class:"main"},Te={key:0,class:"date"},De={class:"chat-title"},Le={class:"name"},Se={class:"time"},Ve={class:"menu-items"},He=["onClick","headline","disabled"],Ne={key:2,class:"chat-title"},Be={class:"name"},Ke={class:"time"},Qe=["innerHTML"],Re={key:0,class:"chat-item replying"},ze={class:"chat-title"},Fe={class:"name"},Ge=["innerHTML"],qe=["placeholder","onKeydown"],Pe={class:"btns"},je=["onClick"],Ee=Me(()=>n("md-ripple",null,null,-1)),Je=X({__name:"AIChatView",setup(g){const q=ee(),{t:P}=te(),j=ae(),r=d(j.params.id),i=d(""),p=d([]),C=d(!1),k=d(""),b=d(""),{app:E,urlTokenKey:J}=se(ne()),x=d(),{render:A}=Ie(E,J);function w(){return r.value==="create"}function U(e,t){let s=!1;if(t==0)s=!0;else{const o=t>0?p.value[t-1]:null;o!=null&&M(o.createdAt)!==M(e.createdAt)&&(s=!0)}return s}w()||oe({handle:async(e,t)=>{if(t)de(P(t),"error");else{const s=[];s.push({...e.aiChat,md:await A(e.aiChat.content)});for(const o of e.aiChats)s.push({...o,md:await A(o.content)});p.value=s,await B(),L()}},document:ue,variables:()=>({id:r.value,query:`parent_id:${r.value} sort:created_at-asc`}),appApi:!0});const{mutate:T,onDone:Y}=N({document:pe,appApi:!0});function D(){!i.value||C.value||T({id:w()?"":r.value,message:i.value,isMe:!0})}Y(async e=>{var s;const t=e.data.createAIChat;if(t){for(const _ of t)(s=p.value)==null||s.push({..._,md:await A(_.content)});w()&&(r.value=t[0].id,ie(q,`/aichats/${r.value}`)),i.value="",C.value=!C.value,k.value="",b.value='<span class="blinking-cursor"></span>',await B(),L()}});function L(){const e=x.value;e&&(e.scrollTop=e.scrollHeight)}const I=d(""),{mutate:Z,loading:O}=N({document:_e,options:{update:e=>{var s,o;e.evict({id:e.identify({__typename:"AIChat",id:I.value})});const t=(s=p.value)==null?void 0:s.findIndex(_=>_.id===I.value);t!==null&&((o=p.value)==null||o.splice(t,1))}},appApi:!0});function W(e){I.value=e,Z({query:`ids:${e}`})}const S=async e=>{e.parentId===r.value&&(k.value+=e.content,b.value=await A(k.value+'<span class="blinking-cursor"></span>'),e.finishReason==="stop"&&T({id:r.value,message:k.value,isMe:!1}))};return le(()=>{F.on("ai_chat_replied",S)}),ce(()=>{F.off("ai_chat_replied",S)}),(e,t)=>{const s=ye,o=ge,_=Ce,V=re("tooltip");return c(),u("div",$e,[n("div",xe,[h(l(we),{class:"chat-container",horizontal:""},{default:f(()=>[h(l(G),{size:"80"},{default:f(()=>[n("div",{class:"chat-items",ref_key:"scrollContainer",ref:x},[(c(!0),u(ve,null,me(p.value,(a,H)=>(c(),u("div",{key:a.id,class:"chat-item"},[U(a,H)?(c(),u("div",Te,v(l(M)(a.createdAt)),1)):K("",!0),H>0?(c(),he(o,{key:1},{content:f(()=>[n("div",Ve,[n("md-menu-item",{onClick:Ue=>W(a.id),headline:e.$t("delete_message"),disabled:l(O)},null,8,He)])]),default:f(()=>[n("div",De,[n("span",Le,v(e.$t(a.isMe?"me":"ai")),1),$((c(),u("span",Se,[R(v(l(z)(a.createdAt)),1)])),[[V,l(Q)(a.createdAt)]]),h(s,{class:"bi bi-more"})])]),_:2},1024)):(c(),u("div",Ne,[n("span",Be,v(e.$t(a.isMe?"me":"ai")),1),$((c(),u("span",Ke,[R(v(l(z)(a.createdAt)),1)])),[[V,l(Q)(a.createdAt)]])])),n("div",{class:"chat-content md-container",innerHTML:a.md},null,8,Qe)]))),128)),C.value?(c(),u("div",Re,[n("div",ze,[n("span",Fe,v(e.$t("ai")),1)]),n("div",{class:"chat-content md-container",innerHTML:b.value},null,8,Ge)])):K("",!0)],512)]),_:1}),h(l(G),{class:"chat-input",size:"12",style:{"min-height":"80px"}},{default:f(()=>[$(n("md-outlined-text-field",{class:"textarea",type:"textarea","onUpdate:modelValue":t[0]||(t[0]=a=>i.value=a),autocomplete:"off",placeholder:e.$t("chat_input_hint"),onKeydown:[y(m(D,["exact","prevent"]),["enter"]),t[1]||(t[1]=y(m(a=>i.value+=`
`,["shift","exact","prevent"]),["enter"])),t[2]||(t[2]=y(m(a=>i.value+=`
`,["ctrl","exact","prevent"]),["enter"])),t[3]||(t[3]=y(m(a=>i.value+=`
`,["alt","exact","prevent"]),["enter"])),t[4]||(t[4]=y(m(a=>i.value+=`
`,["meta","exact","prevent"]),["enter"]))]},null,40,qe),[[fe,i.value]]),n("div",Pe,[n("button",{class:"icon-button",onClick:m(D,["stop"])},[Ee,h(_)],8,je)])]),_:1})]),_:1})])])}}});const We=be(Je,[["__scopeId","data-v-efe3c819"]]);export{We as default};

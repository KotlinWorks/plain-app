import{d as O,a as ee,u as te,p as ae,r as d,s as se,c as ne,i as oe,t as ie,E as N,aW as le,a2 as R,aX as ce,aQ as re,aY as de,J as ue,K as pe,L as _e,o as l,e as u,f as n,x as h,y as f,k as c,F as ve,A as me,j as v,aZ as b,m as B,R as he,M as $,P as K,g as Q,a_ as z,N as fe,ak as y,w as m,a$ as ye,ao as ge,b0 as Ce,au as ke,av as Ae,$ as F,_ as we}from"./index-5e3ce573.js";import{g as G,M as Me}from"./splitpanes.es-97795b24.js";import{u as Ie}from"./markdown-297c002e.js";const be=g=>(ke("data-v-efe3c819"),g=g(),Ae(),g),$e={class:"page-container"},xe={class:"main"},Te={key:0,class:"date"},De={class:"chat-title"},Le={class:"name"},Ve={class:"time"},Se={class:"menu-items"},He=["onClick","headline","disabled"],Ne={key:2,class:"chat-title"},Re={class:"name"},Be={class:"time"},Ke=["innerHTML"],Qe={key:0,class:"chat-item replying"},ze={class:"chat-title"},Fe={class:"name"},Ge=["innerHTML"],qe=["placeholder","onKeydown"],Ee={class:"btns"},Pe=["onClick"],je=be(()=>n("md-ripple",null,null,-1)),Je=O({__name:"AIChatView",setup(g){const q=ee(),{t:E}=te(),P=ae(),r=d(P.params.id),i=d(""),p=d([]),C=d(!1),k=d(""),w=d(""),{app:j,urlTokenKey:J}=se(ne()),x=d(),{render:A}=Ie(j,J);function M(){return r.value==="create"}function U(e,t){let s=!1;if(t==0)s=!0;else{const o=t>0?p.value[t-1]:null;o!=null&&b(o.createdAt)!==b(e.createdAt)&&(s=!0)}return s}M()||oe({handle:async(e,t)=>{if(t)ie(E(t),"error");else{const s=[];s.push({...e.aiChat,md:await A(e.aiChat.content)});for(const o of e.aiChats)s.push({...o,md:await A(o.content)});p.value=s,await N(),L()}},document:le,variables:()=>({id:r.value,query:`parent_id:${r.value} sort:created_at-asc`}),appApi:!0});const{mutate:T,onDone:W}=R({document:ce,appApi:!0});function D(){!i.value||C.value||T({id:M()?"":r.value,message:i.value,isMe:!0})}W(async e=>{var s;const t=e.data.createAIChat;if(t){for(const _ of t)(s=p.value)==null||s.push({..._,md:await A(_.content)});M()&&(r.value=t[0].id,re(q,`/aichats/${r.value}`)),i.value="",C.value=!C.value,k.value="",w.value='<span class="blinking-cursor"></span>',await N(),L()}});function L(){const e=x.value;e&&(e.scrollTop=e.scrollHeight)}const I=d(""),{mutate:X,loading:Y}=R({document:de,options:{update:e=>{var s,o;e.evict({id:e.identify({__typename:"AIChat",id:I.value})});const t=(s=p.value)==null?void 0:s.findIndex(_=>_.id===I.value);t!==null&&((o=p.value)==null||o.splice(t,1))}},appApi:!0});function Z(e){I.value=e,X({query:`ids:${e}`})}const V=async e=>{e.parentId===r.value&&(k.value+=e.content,w.value=await A(k.value+'<span class="blinking-cursor"></span>'),e.finishReason==="stop"&&T({id:r.value,message:k.value,isMe:!1}))};return ue(()=>{F.on("ai_chat_replied",V)}),pe(()=>{F.off("ai_chat_replied",V)}),(e,t)=>{const s=ye,o=ge,_=Ce,S=_e("tooltip");return l(),u("div",$e,[n("div",xe,[h(c(Me),{class:"chat-container",horizontal:""},{default:f(()=>[h(c(G),{size:"80"},{default:f(()=>[n("div",{class:"chat-items",ref_key:"scrollContainer",ref:x},[(l(!0),u(ve,null,me(p.value,(a,H)=>(l(),u("div",{key:a.id,class:"chat-item"},[U(a,H)?(l(),u("div",Te,v(c(b)(a.createdAt)),1)):B("",!0),H>0?(l(),he(o,{key:1},{content:f(()=>[n("div",Se,[n("md-menu-item",{onClick:Ue=>Z(a.id),headline:e.$t("delete_message"),disabled:c(Y)},null,8,He)])]),default:f(()=>[n("div",De,[n("span",Le,v(e.$t(a.isMe?"me":"ai")),1),$((l(),u("span",Ve,[Q(v(c(z)(a.createdAt)),1)])),[[S,c(K)(a.createdAt)]]),h(s,{class:"bi bi-more"})])]),_:2},1024)):(l(),u("div",Ne,[n("span",Re,v(e.$t(a.isMe?"me":"ai")),1),$((l(),u("span",Be,[Q(v(c(z)(a.createdAt)),1)])),[[S,c(K)(a.createdAt)]])])),n("div",{class:"chat-content md-container",innerHTML:a.md},null,8,Ke)]))),128)),C.value?(l(),u("div",Qe,[n("div",ze,[n("span",Fe,v(e.$t("ai")),1)]),n("div",{class:"chat-content md-container",innerHTML:w.value},null,8,Ge)])):B("",!0)],512)]),_:1}),h(c(G),{class:"chat-input",size:"12",style:{"min-height":"80px"}},{default:f(()=>[$(n("md-outlined-text-field",{class:"textarea",type:"textarea","onUpdate:modelValue":t[0]||(t[0]=a=>i.value=a),autocomplete:"off",placeholder:e.$t("chat_input_hint"),onKeydown:[y(m(D,["exact","prevent"]),["enter"]),t[1]||(t[1]=y(m(a=>i.value+=`
`,["shift","exact","prevent"]),["enter"])),t[2]||(t[2]=y(m(a=>i.value+=`
`,["ctrl","exact","prevent"]),["enter"])),t[3]||(t[3]=y(m(a=>i.value+=`
`,["alt","exact","prevent"]),["enter"])),t[4]||(t[4]=y(m(a=>i.value+=`
`,["meta","exact","prevent"]),["enter"]))]},null,40,qe),[[fe,i.value]]),n("div",Ee,[n("button",{class:"icon-button",onClick:m(D,["stop"])},[je,h(_)],8,Pe)])]),_:1})]),_:1})])])}}});const Ze=we(Je,[["__scopeId","data-v-efe3c819"]]);export{Ze as default};

import{d as Y,e as ee,u as te,D as ae,r as d,s as se,f as ne,h as oe,i as B,aQ as ie,V as Q,P as le,Q as R,R as ce,S as re,c as u,a as s,p as h,H as f,k as l,x as de,a$ as ue,b0 as pe,b1 as _e,o as c,F as ve,J as me,t as p,b2 as I,l as N,T as he,m as T,Z as K,j as z,b3 as F,v as fe,ap as y,w as m,b4 as ye,at as Ce,b5 as ge,A as be,B as ke,_ as we}from"./index-6ca6ab55.js";import{g as G,M as Ae}from"./splitpanes.es-cb19a045.js";import{u as Me}from"./markdown-68fe360b.js";const Ie=C=>(be("data-v-c925fee4"),C=C(),ke(),C),Te={class:"page-container"},$e={class:"main"},xe={key:0,class:"date"},De={class:"chat-title"},Ve={class:"name"},Le={class:"time"},Se={class:"menu-items"},He=["onClick","disabled"],Be={slot:"headline"},Qe={key:2,class:"chat-title"},Re={class:"name"},Ne={class:"time"},Ke=["innerHTML"],ze={key:0,class:"chat-item replying"},Fe={class:"chat-title"},Ge={class:"name"},qe=["innerHTML"],Pe=["placeholder","onKeydown"],Ue={class:"btns"},je=["onClick"],Ee=Ie(()=>s("md-ripple",null,null,-1)),Je=Y({__name:"AIChatView",setup(C){const q=ee(),{t:P}=te(),U=ae(),r=d(U.params.id),i=d(""),_=d([]),g=d(!1),b=d(""),w=d(""),{app:j,urlTokenKey:E}=se(ne()),$=d(),{render:k}=Me(j,E);function A(){return r.value==="create"}function J(e,t){let n=!1;if(t==0)n=!0;else{const o=t>0?_.value[t-1]:null;o!=null&&I(o.createdAt)!==I(e.createdAt)&&(n=!0)}return n}A()||oe({handle:async(e,t)=>{if(t)de(P(t),"error");else{const n=[];n.push({...e.aiChat,md:await k(e.aiChat.content)});for(const o of e.aiChats)n.push({...o,md:await k(o.content)});_.value=n,await Q(),V()}},document:ue,variables:()=>({id:r.value,query:`parent_id:${r.value} sort:created_at-asc`}),appApi:!0});const{mutate:x,onDone:Z}=B({document:pe,appApi:!0});function D(){!i.value||g.value||x({id:A()?"":r.value,message:i.value,isMe:!0})}Z(async e=>{var n;const t=e.data.createAIChat;if(t){for(const v of t)(n=_.value)==null||n.push({...v,md:await k(v.content)});A()&&(r.value=t[0].id,ie(q,`/aichats/${r.value}`)),i.value="",g.value=!g.value,b.value="",w.value='<span class="blinking-cursor"></span>',await Q(),V()}});function V(){const e=$.value;e&&(e.scrollTop=e.scrollHeight)}const M=d(""),{mutate:O,loading:W}=B({document:_e,options:{update:e=>{var n,o;e.evict({id:e.identify({__typename:"AIChat",id:M.value})});const t=(n=_.value)==null?void 0:n.findIndex(v=>v.id===M.value);t!==null&&((o=_.value)==null||o.splice(t,1))}},appApi:!0});function X(e){M.value=e,O({query:`ids:${e}`})}const L=async e=>{e.parentId===r.value&&(b.value+=e.content,w.value=await k(b.value+'<span class="blinking-cursor"></span>'),e.finishReason==="stop"&&x({id:r.value,message:b.value,isMe:!1}))};return le(()=>{R.on("ai_chat_replied",L)}),ce(()=>{R.off("ai_chat_replied",L)}),(e,t)=>{const n=ye,o=Ce,v=ge,S=re("tooltip");return c(),u("div",Te,[s("div",$e,[h(l(Ae),{class:"chat-container",horizontal:""},{default:f(()=>[h(l(G),{size:"80"},{default:f(()=>[s("div",{class:"chat-items",ref_key:"scrollContainer",ref:$},[(c(!0),u(ve,null,me(_.value,(a,H)=>(c(),u("div",{key:a.id,class:"chat-item"},[J(a,H)?(c(),u("div",xe,p(l(I)(a.createdAt)),1)):N("",!0),H>0?(c(),he(o,{key:1},{content:f(()=>[s("div",Se,[s("md-menu-item",{onClick:Ze=>X(a.id),disabled:l(W)},[s("div",Be,p(e.$t("delete_message")),1)],8,He)])]),default:f(()=>[s("div",De,[s("span",Ve,p(e.$t(a.isMe?"me":"ai")),1),T((c(),u("span",Le,[z(p(l(F)(a.createdAt)),1)])),[[S,l(K)(a.createdAt)]]),h(n,{class:"bi bi-more"})])]),_:2},1024)):(c(),u("div",Qe,[s("span",Re,p(e.$t(a.isMe?"me":"ai")),1),T((c(),u("span",Ne,[z(p(l(F)(a.createdAt)),1)])),[[S,l(K)(a.createdAt)]])])),s("div",{class:"chat-content md-container",innerHTML:a.md},null,8,Ke)]))),128)),g.value?(c(),u("div",ze,[s("div",Fe,[s("span",Ge,p(e.$t("ai")),1)]),s("div",{class:"chat-content md-container",innerHTML:w.value},null,8,qe)])):N("",!0)],512)]),_:1}),h(l(G),{class:"chat-input",size:"12",style:{"min-height":"80px"}},{default:f(()=>[T(s("md-outlined-text-field",{class:"textarea",type:"textarea","onUpdate:modelValue":t[0]||(t[0]=a=>i.value=a),autocomplete:"off",placeholder:e.$t("chat_input_hint"),onKeydown:[y(m(D,["exact","prevent"]),["enter"]),t[1]||(t[1]=y(m(a=>i.value+=`
`,["shift","exact","prevent"]),["enter"])),t[2]||(t[2]=y(m(a=>i.value+=`
`,["ctrl","exact","prevent"]),["enter"])),t[3]||(t[3]=y(m(a=>i.value+=`
`,["alt","exact","prevent"]),["enter"])),t[4]||(t[4]=y(m(a=>i.value+=`
`,["meta","exact","prevent"]),["enter"]))]},null,40,Pe),[[fe,i.value]]),s("div",Ue,[s("button",{class:"icon-button",onClick:m(D,["stop"])},[Ee,h(v)],8,je)])]),_:1})]),_:1})])])}}});const Ye=we(Je,[["__scopeId","data-v-c925fee4"]]);export{Ye as default};

import{u as ge,D as ye,_ as $e,a as be,b as Ce}from"./list-c18b89b9.js";import{d as we,a9 as Ae,a as De,r as k,u as Se,s as Ie,c as Ve,B as Te,aa as qe,p as Qe,C as Be,ab as Le,D as J,i as Ue,t as ze,ac as Fe,I as Pe,a2 as Me,ad as Re,G as Ge,ae as Ne,J as Ke,K as xe,L as Ee,o,e as i,f as t,x as u,k as a,M as r,w as f,m as V,g as T,j as n,y as je,N as He,F as Y,A as Je,z as Ye,l as Oe,P as O,Q as W,R as We,af as Xe,n as A,S as D,ag as Ze,Y as et,a8 as tt,$ as X}from"./index-2c8e7849.js";import{_ as st}from"./Breadcrumb-01ba2071.js";import{n as at}from"./list-6498ebd9.js";function lt(S,I){const g=S.findIndex(y=>y.id===I);g!==-1&&S.splice(g,1)}const nt={class:"v-toolbar"},ot=t("md-ripple",null,null,-1),it=["onClick"],ct=t("md-ripple",null,null,-1),dt={class:"filters"},ut={class:"form-row"},rt=["label"],pt={class:"buttons"},_t=["onClick"],ht={class:"table-responsive"},ft={class:"table"},mt=["checked","indeterminate"],kt=t("th",null,null,-1),vt=["onClick"],gt=["checked"],yt={class:"v-center"},$t={class:"nowrap"},bt={class:"action-btns"},Ct={key:0,indeterminate:"",class:"spinner-sm"},wt=["onClick"],At=t("md-ripple",null,null,-1),Dt=["onClick"],St=t("md-ripple",null,null,-1),It={class:"nowrap"},Vt={class:"nowrap"},Tt={class:"nowrap"},qt={class:"nowrap"},Qt={key:0},Bt={colspan:"7"},Lt={class:"no-data-placeholder"},v=50,Mt=we({__name:"AppsView",setup(S){var E,j;const{input:I,upload:g,uploadChanged:y}=Ae(),$=De(),c=k([]),q=k(),{t:Z}=Se(),{app:ee,urlTokenKey:Q}=Ie(Ve()),b=Te({text:"",tags:[]}),{allChecked:B,realAllChecked:L,selectRealAll:te,allCheckedAlertVisible:se,clearSelection:U,toggleAllChecked:z,toggleItemChecked:F,total:m,checked:P}=ge(c),{downloadItems:ae}=qe(Q,ye.PACKAGE,c,U,"apps.zip"),{downloadFile:le}=Xe(Q),M=Qe(),R=M.query,C=k(parseInt(((E=R.page)==null?void 0:E.toString())??"1")),d=k(Be(((j=R.q)==null?void 0:j.toString())??"")),G=Le(d.value),p=M.params.type;p&&G.push({name:"type",op:"",value:p});const N=k(J(G)),ne=()=>{g(ee.value.downloadsDir)},{loading:oe}=Ue({handle:(e,l)=>{l?ze(Z(l),"error"):e&&(c.value=e.packages.map(_=>({..._,checked:!1})),m.value=e.packageCount)},document:Fe,variables:()=>({offset:(C.value-1)*v,limit:v,query:N.value}),appApi:!0});Pe(C,e=>{p?A($,`/apps/${p}?page=${e}&q=${D(d.value)}`):A($,`/apps?page=${e}&q=${D(d.value)}`)});function ie(){const e=[];b.text&&e.push({name:"text",op:"",value:b.text}),d.value=J(e),K(),q.value.dismiss()}function K(){p?A($,`/apps/${p}?q=${D(d.value)}`):A($,`/apps?q=${D(d.value)}`)}const{mutate:ce,onDone:de}=Me({document:Re,appApi:!0});function ue(e){de(()=>{e.isUninstalling=!0}),ce({id:e.id})}const{loading:re,load:pe,refetch:_e}=Ge({handle:(e,l)=>{if(e)for(const _ of e.packageStatuses)_.exist||lt(c.value,_.id)},document:Ne,variables:()=>({ids:c.value.filter(e=>e.isUninstalling).map(e=>e.id)}),appApi:!0}),x=e=>{e.status};return Ke(()=>{X.on("upload_task_done",x);let e=!0;setInterval(()=>{c.value.some(l=>l.isUninstalling)&&!re.value&&(e?(pe(),e=!1):_e())},1e3)}),xe(()=>{X.off("upload_task_done",x)}),(e,l)=>{const _=st,H=Ze,he=$e,fe=be,me=et,ke=tt,ve=Ce,h=Ee("tooltip");return o(),i(Y,null,[t("div",nt,[u(_,{current:()=>`${e.$t("page_title.apps")} (${a(m)})`},null,8,["current"]),a(P)?r((o(),i("button",{key:0,class:"icon-button",onClick:l[0]||(l[0]=f(s=>a(ae)(a(L),N.value),["stop"]))},[ot,u(H)])),[[h,e.$t("download")]]):V("",!0),t("button",{class:"icon-button",onClick:f(ne,["stop"]),style:{display:"none"}},[ct,T(" "+n(e.$t("install")),1)],8,it),u(he,{ref_key:"searchInputRef",ref:q,modelValue:d.value,"onUpdate:modelValue":l[2]||(l[2]=s=>d.value=s),search:K},{filters:je(()=>[t("div",dt,[t("div",ut,[r(t("md-outlined-text-field",{label:e.$t("keywords"),"onUpdate:modelValue":l[1]||(l[1]=s=>b.text=s),"keyup.enter":"applyAndDoSearch"},null,8,rt),[[He,b.text]])]),t("div",pt,[t("md-filled-button",{onClick:f(ie,["stop"])},n(e.$t("search")),9,_t)])])]),_:1},8,["modelValue"])]),u(fe,{limit:v,total:a(m),"all-checked-alert-visible":a(se),"real-all-checked":a(L),"select-real-all":a(te),"clear-selection":a(U)},null,8,["total","all-checked-alert-visible","real-all-checked","select-real-all","clear-selection"]),t("div",ht,[t("table",ft,[t("thead",null,[t("tr",null,[t("th",null,[t("md-checkbox",{"touch-target":"wrapper",onChange:l[3]||(l[3]=(...s)=>a(z)&&a(z)(...s)),checked:a(B),indeterminate:!a(B)&&a(P)},null,40,mt)]),t("th",null,n(e.$t("name")),1),kt,t("th",null,n(e.$t("size")),1),t("th",null,n(e.$t("type")),1),t("th",null,n(e.$t("installed_at")),1),t("th",null,n(e.$t("updated_at")),1)])]),t("tbody",null,[(o(!0),i(Y,null,Je(c.value,s=>(o(),i("tr",{key:s.id,class:Ye({selected:s.checked}),onClick:f(w=>s.checked=!s.checked,["stop"])},[t("td",null,[t("md-checkbox",{"touch-target":"wrapper",onChange:l[4]||(l[4]=(...w)=>a(F)&&a(F)(...w)),checked:s.checked},null,40,gt)]),t("td",null,[t("strong",yt,n(s.name)+" ("+n(s.version)+")",1),u(me,{id:s.id,raw:s},null,8,["id","raw"])]),t("td",$t,[t("div",bt,[s.isUninstalling?r((o(),i("md-circular-progress",Ct,null,512)),[[h,e.$t("uninstalling")]]):r((o(),i("button",{key:1,class:"icon-button",onClick:f(w=>ue(s),["stop"])},[At,u(ke)],8,wt)),[[h,e.$t("uninstall")]]),r((o(),i("button",{class:"icon-button",onClick:f(w=>a(le)(s.path,`${s.name.replace(" ","")}-${s.id}.apk`),["stop"])},[St,u(H)],8,Dt)),[[h,e.$t("download")]])])]),t("td",It,n(a(Oe)(s.size)),1),t("td",Vt,n(e.$t("app_type."+s.type)),1),t("td",Tt,[r((o(),i("span",null,[T(n(a(W)(s.installedAt)),1)])),[[h,a(O)(s.installedAt)]])]),t("td",qt,[r((o(),i("span",null,[T(n(a(W)(s.updatedAt)),1)])),[[h,a(O)(s.updatedAt)]])])],10,vt))),128))]),c.value.length?V("",!0):(o(),i("tfoot",Qt,[t("tr",null,[t("td",Bt,[t("div",Lt,n(e.$t(a(at)(a(oe)))),1)])])]))])]),a(m)>v?(o(),We(ve,{key:0,modelValue:C.value,"onUpdate:modelValue":l[5]||(l[5]=s=>C.value=s),total:a(m),limit:v},null,8,["modelValue","total"])):V("",!0),t("input",{ref_key:"fileInput",ref:I,style:{display:"none"},type:"file",accept:".apk",multiple:"",onChange:l[6]||(l[6]=(...s)=>a(y)&&a(y)(...s))},null,544)],64)}}});export{Mt as default};

import{b as me,u as he,_ as fe,a as ge}from"./list-3f4b71c4.js";import{d as ve,p as ye,s as $e,a as ke,r as p,u as be,C as Ce,n as Te,D as we,E as O,G as Se,L as T,a1 as De,H as Ae,t as Ve,a2 as Le,J as qe,K as Ie,M as Be,a3 as Me,a4 as Ge,N as Ne,o as l,c,e as t,x as d,j as o,F as w,O as _,w as m,l as V,y as Qe,P as Re,g as a,A as P,z as Ue,a5 as ze,R as Ee,f as Fe,S as je,T as He,B as S,U as D,X as x,Y as Ke,V as Oe,a6 as Pe,a7 as xe,a8 as Je,a9 as Xe,Z as Ye,$ as Ze,a0 as We}from"./index-df35a132.js";import{_ as et}from"./call-outline-rounded-25fb676d.js";import{_ as tt}from"./Breadcrumb-120bdd32.js";import{n as st}from"./list-6498ebd9.js";import{u as nt,a as ot}from"./tags-ecacebdb.js";import"./vee-validate.esm-aa1410cb.js";const at={class:"v-toolbar"},lt={class:"filters"},ct=["label"],it={class:"form-label"},dt={type:"filter"},ut=["label","selected","onClick"],rt={class:"buttons"},pt=["onClick"],_t={class:"table-responsive"},mt={class:"table"},ht=["checked"],ft=t("th",null,"ID",-1),gt=t("th",null,null,-1),vt=["onClick"],yt=["checked"],$t={class:"v-center"},kt={class:"nowrap"},bt={class:"action-btns"},Ct=["onClick"],Tt={key:0,indeterminate:"",class:"spinner-sm"},wt=["onClick"],St=["onClick"],Dt={class:"nowrap"},At={class:"nowrap"},Vt={class:"nowrap"},Lt={key:0},qt={colspan:"10"},It={class:"no-data-placeholder"},h="CALL",A=50,Et=ve({__name:"CallsView",setup(Bt){var F,j;const y=ye(),{app:J}=$e(ke()),r=p([]),L=p(),{t:q}=be(),i=Ce({text:"",tags:[]}),I=Te(),B=I.query,$=p(parseInt(((F=B.page)==null?void 0:F.toString())??"1")),k=p(0),u=p(we(((j=B.q)==null?void 0:j.toString())??"")),M=p(""),{tags:b}=nt(h,u,i,async e=>{f&&e.push({name:"type",op:"",value:ee[f].toString()}),M.value=O(e),await Se(),W()}),{addToTags:G}=ot(h,r,b),{deleteItems:N}=me(De,()=>{R(),r.value.some(e=>e.tags.length)&&T.emit("refetch_tags",h)},r),{selectAll:X,toggleSelect:Q,checked:Y}=he(r),{loading:Z,load:W,refetch:R}=Ae({handle:(e,n)=>{n?Ve(q(n),"error"):e&&(r.value=e.calls.map(v=>({...v,checked:!1})),k.value=e.callCount)},document:Le,variables:()=>({offset:($.value-1)*A,limit:A,query:M.value}),appApi:!0}),f=I.params.type,ee={incoming:1,outgoing:2,missed:3};qe($,e=>{f?S(y,`/calls/${f}?page=${e}&q=${D(u.value)}`):S(y,`/calls?page=${e}&q=${D(u.value)}`)});function te(e){x(Ke,{tagType:h,tags:b.value,item:{key:e.id,title:"",size:0},selected:b.value.filter(n=>e.tags.some(v=>v.id===n.id))})}function se(e){i.tags.includes(e)?Oe(i.tags,n=>n.id===e.id):i.tags.push(e)}function ne(){const e=[];for(const n of i.tags)e.push({name:"tag",op:"",value:Pe.kebabCase(n.name)});i.text&&e.push({name:"text",op:"",value:i.text}),u.value=O(e),U(),L.value.dismiss()}function U(){f?S(y,`/calls/${f}?q=${D(u.value)}`):S(y,`/calls?q=${D(u.value)}`)}const z=e=>{e===h&&R()};Ie(()=>{T.on("refetch_by_tag_type",z)}),Be(()=>{T.off("refetch_by_tag_type",z)});function oe(e){if(!e)return"";const n=[];return e.isp&&n.push(q("phone_isp_type."+e.isp)),e.city===e.province?n.push(e.city):n.push(`${e.province}${e.city}`),n.join(", ")}const E=p(""),{mutate:ae,loading:le}=Me({document:Ge,appApi:!0});function ce(e){E.value=e.id,ae({number:e.number})}function ie(e){x(Je,{id:e.id,name:e.id,gql:xe`
      mutation DeleteCall($id: ID!) {
        deleteCalls(ids: [$id])
      }
    `,appApi:!0,typeName:"Call",done:()=>{e.tags.length&&T.emit("refetch_tags",h)}})}return(e,n)=>{const v=tt,H=Xe,K=Ye,de=fe,ue=Ze,re=et,pe=We,_e=ge,g=Ne("tooltip");return l(),c(w,null,[t("div",at,[d(v,{current:()=>`${e.$t("page_title.calls")} (${k.value})`},null,8,["current"]),o(Y)?(l(),c(w,{key:0},[_((l(),c("md-icon-button",{type:"button",onClick:n[0]||(n[0]=m((...s)=>o(N)&&o(N)(...s),["stop"]))},[d(H)])),[[g,e.$t("delete")]]),_((l(),c("md-icon-button",{type:"button",onClick:n[1]||(n[1]=m((...s)=>o(G)&&o(G)(...s),["stop"]))},[d(K)])),[[g,e.$t("add_to_tags")]])],64)):V("",!0),d(de,{ref_key:"searchInputRef",ref:L,modelValue:u.value,"onUpdate:modelValue":n[3]||(n[3]=s=>u.value=s),search:U},{filters:Qe(()=>[t("div",lt,[_(t("md-outlined-text-field",{label:e.$t("keywords"),"onUpdate:modelValue":n[2]||(n[2]=s=>i.text=s),"keyup.enter":"applyAndDoSearch"},null,8,ct),[[Re,i.text]]),t("label",it,a(e.$t("tags")),1),t("md-chip-set",dt,[(l(!0),c(w,null,P(o(b),s=>(l(),c("md-filter-chip",{key:s.id,label:s.name,selected:i.tags.includes(s),onClick:C=>se(s)},null,8,ut))),128))]),t("div",rt,[t("md-filled-button",{onClick:m(ne,["stop"])},a(e.$t("search")),9,pt)])])]),_:1},8,["modelValue"])]),t("div",_t,[t("table",mt,[t("thead",null,[t("tr",null,[t("th",null,[t("md-checkbox",{"touch-target":"wrapper",onChange:n[4]||(n[4]=(...s)=>o(Q)&&o(Q)(...s)),checked:o(X)},null,40,ht)]),ft,t("th",null,a(e.$t("name")),1),t("th",null,a(e.$t("phone_number")),1),gt,t("th",null,a(e.$t("phone_geo")),1),t("th",null,a(e.$t("duration")),1),t("th",null,a(e.$t("type")),1),t("th",null,a(e.$t("tags")),1),t("th",null,a(e.$t("started_at")),1)])]),t("tbody",null,[(l(!0),c(w,null,P(r.value,s=>(l(),c("tr",{key:s.id,class:Ue({selected:s.checked}),onClick:m(C=>s.checked=!s.checked,["stop"])},[t("td",null,[t("md-checkbox",{"touch-target":"wrapper",checked:s.checked},null,8,yt)]),t("td",null,[d(ue,{id:s.id,raw:s},null,8,["id","raw"])]),t("td",null,a(s.name),1),t("td",null,[t("div",$t,a(s.number),1)]),t("td",kt,[t("div",bt,[_((l(),c("md-icon-button",{onClick:m(C=>ie(s),["stop"])},[d(H)],8,Ct)),[[g,e.$t("delete")]]),o(le)&&E.value===s.id?(l(),c("md-circular-progress",Tt)):_((l(),c("md-icon-button",{key:1,onClick:m(C=>ce(s),["stop"])},[d(re)],8,wt)),[[g,e.$t("make_a_phone_call")]]),_((l(),c("md-icon-button",{onClick:m(C=>te(s),["stop"])},[d(K)],8,St)),[[g,e.$t("add_to_tags")]])])]),t("td",null,a(oe(s.geo)),1),t("td",Dt,a(o(ze)(s.duration)),1),t("td",At,a(e.$t("call_type."+s.type)),1),t("td",null,[d(pe,{tags:s.tags,tagType:h},null,8,["tags"])]),t("td",Vt,[_((l(),c("span",null,[Fe(a(o(je)(s.startedAt)),1)])),[[g,o(Ee)(s.startedAt)]])])],10,vt))),128))]),r.value.length?V("",!0):(l(),c("tfoot",Lt,[t("tr",null,[t("td",qt,[t("div",It,a(e.$t(o(st)(o(Z),o(J).permissions,"READ_CALL_LOG"))),1)])])]))])]),k.value>A?(l(),He(_e,{key:0,modelValue:$.value,"onUpdate:modelValue":n[5]||(n[5]=s=>$.value=s),total:k.value,limit:A},null,8,["modelValue","total"])):V("",!0)],64)}}});export{Et as default};

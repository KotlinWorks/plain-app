import{D as $e,c as be,u as Ce,_ as Te,a as Ae,b as we}from"./list-052a81ba.js";import{d as De,a as Se,s as qe,c as Ve,r as k,u as Le,B as Ie,p as Be,C as Qe,D as W,E as Re,$ as y,a0 as Ge,G as Me,t as Ne,a1 as Ue,I as ze,J as Ee,K as Fe,a2 as je,a3 as He,L as Ke,o,e as c,f as t,x as d,k as l,F as D,M as _,w as m,m as I,y as Pe,N as xe,j as n,A as X,z as Je,a4 as Oe,P as We,g as Xe,Q as Ye,R as Ze,n as S,S as q,V as Y,W as et,T as tt,a5 as st,a6 as lt,a7 as at,a8 as nt,X as ot,Y as ct,Z as it}from"./index-5e3ce573.js";import{_ as dt}from"./call-outline-rounded-74b32bfd.js";import{_ as ut}from"./Breadcrumb-db3f2c63.js";import{n as rt}from"./list-6498ebd9.js";import{u as pt,a as _t}from"./tags-25ba5c36.js";import"./vee-validate.esm-e8a787ff.js";const mt={class:"v-toolbar"},ht=t("md-ripple",null,null,-1),ft=t("md-ripple",null,null,-1),gt={class:"filters"},vt=["label"],kt={class:"form-label"},yt={type:"filter"},$t=["label","selected","onClick"],bt={class:"buttons"},Ct=["onClick"],Tt={class:"table-responsive"},At={class:"table"},wt=["checked","indeterminate"],Dt=t("th",null,"ID",-1),St=t("th",null,null,-1),qt=["onClick"],Vt=["checked"],Lt={class:"v-center"},It={class:"nowrap"},Bt={class:"action-btns"},Qt=["onClick"],Rt=t("md-ripple",null,null,-1),Gt={key:0,indeterminate:"",class:"spinner-sm"},Mt=["onClick"],Nt=t("md-ripple",null,null,-1),Ut=["onClick"],zt=t("md-ripple",null,null,-1),Et={class:"nowrap"},Ft={class:"nowrap"},jt={class:"nowrap"},Ht={key:0},Kt={colspan:"10"},Pt={class:"no-data-placeholder"},b=50,ts=De({__name:"CallsView",setup(xt){var P,x;const C=Se(),{app:Z}=qe(Ve()),p=k([]),B=k(),{t:Q}=Le(),i=Ie({text:"",tags:[]}),u=$e.CALL,R=Be(),G=R.query,T=k(parseInt(((P=G.page)==null?void 0:P.toString())??"1")),r=k(Qe(((x=G.q)==null?void 0:x.toString())??"")),A=k(""),{tags:w}=pt(u,r,i,async e=>{f&&e.push({name:"type",op:"",value:oe[f].toString()}),A.value=W(e),await Re(),ne()}),{addToTags:ee}=_t(u,p,w),{deleteItems:te}=be(Ge,()=>{L(),p.value.some(e=>e.tags.length)&&y.emit("refetch_tags",u)},p),{allChecked:M,realAllChecked:V,selectRealAll:se,allCheckedAlertVisible:le,clearSelection:N,toggleAllChecked:U,toggleItemChecked:z,total:h,checked:E}=Ce(p),{loading:ae,load:ne,refetch:L}=Me({handle:(e,a)=>{a?Ne(Q(a),"error"):e&&(p.value=e.calls.map($=>({...$,checked:!1})),h.value=e.callCount)},document:Ue,variables:()=>({offset:(T.value-1)*b,limit:b,query:A.value}),appApi:!0}),f=R.params.type,oe={incoming:1,outgoing:2,missed:3};ze(T,e=>{f?S(C,`/calls/${f}?page=${e}&q=${q(r.value)}`):S(C,`/calls?page=${e}&q=${q(r.value)}`)});function ce(e){Y(et,{type:u,tags:w.value,item:{key:e.id,title:"",size:0},selected:w.value.filter(a=>e.tags.some($=>$.id===a.id))})}function ie(e){i.tags.includes(e)?tt(i.tags,a=>a.id===e.id):i.tags.push(e)}function de(){const e=[];for(const a of i.tags)e.push({name:"tag",op:"",value:st.kebabCase(a.name)});i.text&&e.push({name:"text",op:"",value:i.text}),r.value=W(e),F(),B.value.dismiss()}function F(){f?S(C,`/calls/${f}?q=${q(r.value)}`):S(C,`/calls?q=${q(r.value)}`)}const j=e=>{e.type===u&&(N(),L())},H=e=>{e.type===u&&L()};Ee(()=>{y.on("item_tags_updated",H),y.on("items_tags_updated",j)}),Fe(()=>{y.off("item_tags_updated",H),y.off("items_tags_updated",j)});function ue(e){if(!e)return"";const a=[];return e.isp&&a.push(Q("phone_isp_type."+e.isp)),e.city===e.province?a.push(e.city):a.push(`${e.province}${e.city}`),a.join(", ")}const K=k(""),{mutate:re,loading:pe}=je({document:He,appApi:!0});function _e(e){K.value=e.id,re({number:e.number})}function me(e){Y(at,{id:e.id,name:e.id,gql:lt`
      mutation DeleteCall($query: String!) {
        deleteCalls(query: $query)
      }
    `,variables:()=>({query:`ids:${e.id}`}),appApi:!0,typeName:"Call",done:()=>{h.value--,e.tags.length&&y.emit("refetch_tags",u)}})}return(e,a)=>{const $=ut,J=nt,O=ot,he=Te,fe=Ae,ge=ct,ve=dt,ke=it,ye=we,g=Ke("tooltip");return o(),c(D,null,[t("div",mt,[d($,{current:()=>`${e.$t("page_title.calls")} (${l(h)})`},null,8,["current"]),l(E)?(o(),c(D,{key:0},[_((o(),c("button",{class:"icon-button",onClick:a[0]||(a[0]=m(s=>l(te)(l(V),A.value),["stop"]))},[ht,d(J)])),[[g,e.$t("delete")]]),_((o(),c("button",{class:"icon-button",onClick:a[1]||(a[1]=m(s=>l(ee)(l(V),A.value),["stop"]))},[ft,d(O)])),[[g,e.$t("add_to_tags")]])],64)):I("",!0),d(he,{ref_key:"searchInputRef",ref:B,modelValue:r.value,"onUpdate:modelValue":a[3]||(a[3]=s=>r.value=s),search:F},{filters:Pe(()=>[t("div",gt,[_(t("md-outlined-text-field",{label:e.$t("keywords"),"onUpdate:modelValue":a[2]||(a[2]=s=>i.text=s),"keyup.enter":"applyAndDoSearch"},null,8,vt),[[xe,i.text]]),t("label",kt,n(e.$t("tags")),1),t("md-chip-set",yt,[(o(!0),c(D,null,X(l(w),s=>(o(),c("md-filter-chip",{key:s.id,label:s.name,selected:i.tags.includes(s),onClick:v=>ie(s)},null,8,$t))),128))]),t("div",bt,[t("md-filled-button",{onClick:m(de,["stop"])},n(e.$t("search")),9,Ct)])])]),_:1},8,["modelValue"])]),d(fe,{limit:b,total:l(h),"all-checked-alert-visible":l(le),"real-all-checked":l(V),"select-real-all":l(se),"clear-selection":l(N)},null,8,["total","all-checked-alert-visible","real-all-checked","select-real-all","clear-selection"]),t("div",Tt,[t("table",At,[t("thead",null,[t("tr",null,[t("th",null,[t("md-checkbox",{"touch-target":"wrapper",onChange:a[4]||(a[4]=(...s)=>l(U)&&l(U)(...s)),checked:l(M),indeterminate:!l(M)&&l(E)},null,40,wt)]),Dt,t("th",null,n(e.$t("name")),1),t("th",null,n(e.$t("phone_number")),1),St,t("th",null,n(e.$t("phone_geo")),1),t("th",null,n(e.$t("duration")),1),t("th",null,n(e.$t("type")),1),t("th",null,n(e.$t("tags")),1),t("th",null,n(e.$t("started_at")),1)])]),t("tbody",null,[(o(!0),c(D,null,X(p.value,s=>(o(),c("tr",{key:s.id,class:Je({selected:s.checked}),onClick:m(v=>s.checked=!s.checked,["stop"])},[t("td",null,[t("md-checkbox",{"touch-target":"wrapper",onChange:a[5]||(a[5]=(...v)=>l(z)&&l(z)(...v)),checked:s.checked},null,40,Vt)]),t("td",null,[d(ge,{id:s.id,raw:s},null,8,["id","raw"])]),t("td",null,n(s.name),1),t("td",null,[t("div",Lt,n(s.number),1)]),t("td",It,[t("div",Bt,[_((o(),c("button",{class:"icon-button",onClick:m(v=>me(s),["stop"])},[Rt,d(J)],8,Qt)),[[g,e.$t("delete")]]),l(pe)&&K.value===s.id?(o(),c("md-circular-progress",Gt)):_((o(),c("button",{key:1,class:"icon-button",onClick:m(v=>_e(s),["stop"])},[Nt,d(ve)],8,Mt)),[[g,e.$t("make_a_phone_call")]]),_((o(),c("button",{class:"icon-button",onClick:m(v=>ce(s),["stop"])},[zt,d(O)],8,Ut)),[[g,e.$t("add_to_tags")]])])]),t("td",null,n(ue(s.geo)),1),t("td",Et,n(l(Oe)(s.duration)),1),t("td",Ft,n(e.$t("call_type."+s.type)),1),t("td",null,[d(ke,{tags:s.tags,type:l(u)},null,8,["tags","type"])]),t("td",jt,[_((o(),c("span",null,[Xe(n(l(Ye)(s.startedAt)),1)])),[[g,l(We)(s.startedAt)]])])],10,qt))),128))]),p.value.length?I("",!0):(o(),c("tfoot",Ht,[t("tr",null,[t("td",Kt,[t("div",Pt,n(e.$t(l(rt)(l(ae),l(Z).permissions,"READ_CALL_LOG"))),1)])])]))])]),l(h)>b?(o(),Ze(ye,{key:0,modelValue:T.value,"onUpdate:modelValue":a[6]||(a[6]=s=>T.value=s),total:l(h),limit:b},null,8,["modelValue","total"])):I("",!0)],64)}}});export{ts as default};
